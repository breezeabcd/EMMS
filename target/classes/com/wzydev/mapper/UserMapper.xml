<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wzydev.mapper.UserMapper">
    <update id="updateById">
        update user_info u
        <set>
            <if test="username != null and username != ''">
                username = #{username},
            </if>
            <if test="password != null and password != ''">
                password = #{password},
            </if>
            <if test="deptId != null">
                dept_id = #{deptId},
            </if>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="photo != null and photo != ''">
                photo = #{photo},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone},
            </if>
            <if test="gender != null">
                gender = #{gender},
            </if>
        </set> where id = #{id}
    </update>

    <!--注意下面这条sql不能把(和)放在#{id}两边，那样会导致最后的sql变成delete from user_info where id in (?), (?), (?),这是错误的sql-->
    <delete id="deleteByIds">
        delete from user_info where id in
        <foreach item="id" collection="ids" separator="," open="(" close=")">
            #{id}
        </foreach>
    </delete>

    <select id="list" resultType="com.wzydev.pojo.User">
        select u.*, d.name deptName from user_info u left join dept_info d on u.dept_id = d.id
        <where>
            <if test="name != null and name != ''">
                u.name like concat('%', #{name}, '%')
            </if>
            <if test="phone != null and phone != ''">
                and u.phone like concat('%', #{phone}, '%')
            </if>
            <if test="gender != null">
                and u.gender = #{gender}
            </if>
        </where> order by u.update_time desc
    </select>

    <!--定义userResultMap
    将字段一一封装到属性中-->
    <resultMap id="userResultMap" type="com.wzydev.pojo.User">
        <id column="id" property="id"/>
        <!--把字段username封装到User中的属性username-->
        <result column="username" property="username"/>
        <result column="password" property="password"/>
        <result column="dept_id" property="deptId"/>
        <result column="name" property="name"/>
        <result column="photo" property="photo"/>
        <result column="phone" property="phone"/>
        <result column="gender" property="gender"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>

        <!--封装工作经历信息-->
        <collection property="userExprList" ofType="com.wzydev.pojo.UserExpr">
            <id column="ue_id" property="id"/>
            <result column="ue_userid" property="userId"/>
            <result column="ue_company" property="company"/>
            <result column="ue_job" property="job"/>
            <result column="ue_begin" property="begin"/>
            <result column="ue_end" property="end"/>
        </collection>
    </resultMap>

    <select id="getById" resultMap="userResultMap">
        select
            u.*,
            ue.id ue_id,
            ue.user_id ue_userid,
            ue.company ue_company,
            ue.job ue_job,
            ue.begin ue_begin,
            ue.end ue_end
        from user_info u left join user_expr ue on u.id = ue.user_id
        where u.id = #{id}
    </select>

</mapper>